#!/usr/bin/bash -l

<%= ERB.new(File.read('../common_files/work_directory_change.sh.erb'), eoutvar: 'child').result(binding) %>

# Benchmark info
echo "TIMING - Starting main script at: $(date)"

TOOLCHAIN=<%= context.toolchain %>

modules_to_load=()

case "${TOOLCHAIN}" in
  2023a )
    modules_to_load+=("ParaView/5.11.2-foss-2023a")
    ;;
  2024a )
    modules_to_load+=("ParaView/5.13.2-foss-2024a")
    ;;
  * )
    echo "ERROR: Unsupported toolchain selected"
    exit 1
    ;;
esac

if [ ${SLURM_GPUS_ON_NODE:-0} -gt 0 ]; then
  gpu_bus_id=$(nvidia-smi --query-gpu=gpu_bus_id --format=csv,noheader)
  # to lowercase
  gpu_bus_id=${gpu_bus_id,,}
  # Need to strip off first 4 zeros
  dri_device=$(ls -d /sys/bus/pci/devices/${gpu_bus_id:4}/drm/card*)
  export VGL_DISPLAY=/dev/dri/${dri_device##*/}
  export VGL_LOGO=1 # for testing
  echo "Setting VGL_DISPLAY to $VGL_DISPLAY"
else
  export VGL_DISPLAY=$DISPLAY
fi

<%- unless context.global_prerun.empty? -%>
<%= context.global_prerun.gsub("\r", "") %>
<%- end -%>

cat >$OOD_SESSION_STAGED_ROOT/autostart.sh <<EOF
bash -c 'echo Starting ParaView ... && module load ${modules_to_load[@]} && paraview'
EOF

# Start up desktop
echo "Launching desktop '<%= context.desktop %>'..."
<%= ERB.new(File.read("../common_files/desktops/#{context.desktop}.sh.erb"), eoutvar: 'child').result(binding) %>

echo "Desktop '<%= context.desktop %>' ended with $? status..."
