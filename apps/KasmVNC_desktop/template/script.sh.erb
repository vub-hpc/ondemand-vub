#!/usr/bin/bash -l

<%= ERB.new(File.read('../common_files/work_directory_change.sh.erb'), eoutvar: 'child').result(binding) %>

# Ensure that the user's configured login shell is used
export SHELL="$(getent passwd $USER | cut -d: -f7)"

<%= ERB.new(File.read('../common_files/oodegl.sh.erb'), eoutvar: 'child').result(binding) %>

read DISPLAY VNC_PID <<<$(tail -1 $OOD_SESSION_STAGED_ROOT/vncserver_list )
export DISPLAY
echo "Found running Xvnc pid $VNC_PID for display $DISPLAY"

# open port 590X, most vncserver coe uses this to detect other Xvnc to make sure display numbers are unique
fakeport=$((5900+${DISPLAY##*:}))
echo "Faking rfbport $fakeport"
nc -l $fakeport --keep-open >& /dev/null &
 
# Start up desktop
echo "Launching desktop '<%= context.desktop %>'..."
source "<%= session.staged_root.join("desktops", "#{context.desktop}.sh") %>"
echo "Desktop '<%= context.desktop %>' ended with $? status..."
